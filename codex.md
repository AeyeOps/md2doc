 # Code Decks

 This document provides an overview of the project structure, diagnoses issues with the GitHub Release workflow, and outlines a game plan for remediation.

 ## 1. Repository Structure
 - `.github/workflows/`
   - `ci.yml` - Continuous integration for testing and multi-OS builds
   - `release.yml` - Release workflow triggered on tag pushes and manual dispatch
 - `cmd/md2docx/` - Main Go CLI application entrypoint
 - `examples/` - Sample markdown inputs
 - `packaging/`
   - `homebrew/` - Homebrew formula
   - `windows/` - NSIS installer script
 - `KB/` - Knowledge base and workflow documentation
 - `CHANGELOG.md`, `README.md` - Project documentation
 - `go.mod`, `package-lock.json` - Dependency manifests

 ## 2. Current Release Workflow (`.github/workflows/release.yml`)
 1. Triggers:
    - `push` on tags matching `v*.*.*`
    - `workflow_dispatch` (manual)
 2. Steps:
    - Checkout code, setup Go
    - Build binaries for `linux_amd64`, `windows_amd64`, `darwin_amd64`
    - Package artifacts: `.deb`, `.tar.gz`, `.zip`, NSIS installer
    - Create GitHub Release with `actions/create-release@v1`
    - Upload assets with `actions/upload-release-asset@v1`

 ## 3. Issues Identified
 - **Trigger gaps**: creating a Release via GitHub UI does not fire `push`-tag events.
 - **Version parsing**: `VERSION=${GITHUB_REF#refs/tags/}` fails on manual dispatch (`GITHUB_REF` may default to branch).
 - **Manual dispatch** lacks an input parameter to specify the tag/version.
 - **NSIS substitution mismatch**: sed pattern targets `$VERSION` but the script uses `${VERSION}`.
- **Action versions**: using older `actions/create-release@v1` and `upload-release-asset@v1` (consider updating).
- **Empty VERSION value**: the shell expression `VERSION=${GITHUB_REF#refs/tags/}` can yield an empty string (e.g. during tag-triggered runs), leading to artifact names like `md2docx__linux_amd64`.
- **Asset naming inconsistencies**: slight divergence in naming patterns (`_linux_amd64` vs `_amd64`).
- **No checksum generation**: release artifacts lack SHA256 checksum files for verification.
- **Workflow permissions**: no explicit `permissions:` block, granting broader access than necessary to `GITHUB_TOKEN`.
- **Unpinned actions**: marketplace actions are referenced by major-version tags without SHA pinning, increasing supply-chain risk.

 ## 4. Proposed Game Plan
 1. **Enhance triggers**:
    - Add `release: [created]` event to support GitHub UI–created releases.
 2. **Refactor version handling**:
    - Remove shell-based parsing; use `${{ github.ref_name }}` for tag-push events and `${{ github.event.release.tag_name }}` for `release` events.
    - Introduce a `workflow_dispatch` input `version` and fall back to `${{ github.ref_name }}` when absent.
 3. **Fix NSIS placeholder**:
    - Align `installer.nsi` placeholders (`$VERSION` vs `${VERSION}`) or adjust sed regex.
 4. **Upgrade Actions**:
    - Move to `actions/create-release@v2+`, `actions/upload-release-asset@v2+`.
 5. **Standardize names**:
    - Choose a consistent asset naming scheme (e.g. `md2docx-${version}-${os}-${arch}${ext}`).
 6. **Add Go cache**:
    - Cache modules using `actions/cache@v3` for CI and Release builds.
 7. **Validation & Testing**:
    - Add a dry-run mode or separate test workflow to verify artifact generation.
 8. **Generate checksums**:
    - Compute SHA256 checksums for all packages and upload alongside release assets.
 9. **Minimize permissions**:
    - Define an explicit `permissions:` block in `release.yml` to grant only necessary scopes.
 10. **Pin actions**:
    - Reference actions by commit SHA or full tag for critical workflows (e.g., checkout, setup-go).
 11. **Adopt GoReleaser**:
    - Evaluate migrating to GoReleaser to unify build, archive, and release steps.
 12. **Extract reusable workflows**:
    - Factor common CI/release steps into `workflow_call`–based workflows or composite actions for reuse.

 ## 5. Next Steps / Action Items
 - [ ] Draft updated `release.yml` with new triggers and inputs
 - [ ] Implement version-resolution logic and test locally
 - [ ] Investigate Debian packaging error (`md2docx__linux_amd64` not found) and correct binary paths once VERSION is fixed
 - [ ] Adjust NSIS script and sed invocation
 - [ ] Update action versions and validate asset uploads
 - [ ] Run end-to-end test by pushing a `vX.Y.Z` tag and checking the release artifacts
- [ ] Document changes in `README.md` or CONTRIBUTING.md
- [ ] Add SHA256 checksum generation and upload to the release
- [ ] Add and enforce minimal `permissions:` in `release.yml`
- [ ] Pin key actions to specific commit SHAs
- [ ] Evaluate migration to GoReleaser for end-to-end releases
- [ ] Create reusable workflows or composite actions for shared steps

 _Generated by Codex CLI analysis_